version: "3.8"

services:
  manager:
    image: trendsearth_api
    build: .
    extends:
      file: base.yml
      service: base
    environment:
      PORT: 3000
      ENVIRONMENT: dev
      DEBUG: "True"
      FLASK_APP: main.py
    container_name: te_api-manager-develop
    ports:
      - 3000:3000
    env_file:
      - develop.env
    command: start
    volumes:
      - ./gefapi:/opt/gef-api/gefapi
      - ./migrations:/opt/gef-api/migrations
      - /var/run/docker.sock:/tmp/docker.sock
    restart: always
    links:
      - database
      - registry
      - redis

  worker:
    image: trendsearth_api
    build: .
    extends:
      file: base.yml
      service: base
    environment:
      PORT: 3000
      ENVIRONMENT: dev
      DEBUG: "True"
      FLASK_APP: main.py
    container_name: te_api_worker-develop
    env_file:
      - develop.env
    command: worker
    volumes:
      - ./gefapi:/opt/gef-api/gefapi
      - ./migrations:/opt/gef-api/migrations
      - /var/run/docker.sock:/tmp/docker.sock
    restart: always
    links:
      - database
      - registry
      - redis

  database:
    image: postgres:9.6
    container_name: te_api-database
    env_file:
      - develop.env
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=root
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    restart: always

  registry:
    image: registry:2.6.1
    container_name: te_api-registry
    env_file:
      - develop.env
    ports:
      - 5000
    restart: always

  redis:
    image: redis
    container_name: te_api-redis
    env_file:
      - develop.env
    ports:
      - 6379
    restart: always

volumes:
  postgres-data:
    external: true
